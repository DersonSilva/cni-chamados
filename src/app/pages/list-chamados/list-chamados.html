<p-toast position="top-center" class="responsive-toast"></p-toast>

<p-confirmDialog #cd styleClass="max-w-md mx-4 md:w-1/2 lg:w-1/3 xl:w-1/4">
  <ng-template #headless let-message let-onAccept="onAccept" let-onReject="onReject">
    <div class="flex flex-col gap-4 p-6 rounded shadow">
      <p class="font-bold flex items-center gap-2">
        <i class="pi pi-trash text-red-600"></i>
        {{ message.header }}
      </p>
      <p>{{ message.message }}</p>

      <div class="flex justify-end gap-2 mt-4">
        <p-button label="Não" severity="danger" [outlined]="true" (onClick)="onReject()"></p-button>
        <p-button
          label="Sim"
          severity="success"
          [outlined]="true"
          (onClick)="onAccept()"
        ></p-button>
      </div>
    </div>
  </ng-template>
</p-confirmDialog>

<div class="w-full max-w-6xl mx-auto p-4">
  <header
    class="flex flex-col items-end sm:flex-row sm:items-center sm:justify-end gap-3 mb-6 mt-3"
  >
    <p-button
      label="Novo Chamado"
      icon="pi pi-plus"
      (click)="goToCreate()"
      variant="outlined"
      severity="success"
    ></p-button>
  </header>

  <p-table
    [value]="filteredChamados()"
    [paginator]="true"
    [rows]="10"
    [loading]="loading"
    [stripedRows]="true"
    [showGridlines]="true"
    responsiveLayout="stack"
    [stripedRows]="true"
    [rowHover]="true"
  >
    <ng-template pTemplate="header">
      <tr>
        <th>ID</th>
        <th>Título</th>
        <th>Descrição</th>
        <th class="text-center">Categoria</th>
        <th style="text-align: center !important">Data</th>
        <th class="flex text-center justify-center">Ações</th>
      </tr>
    </ng-template>

    <ng-template pTemplate="body" let-chamado>
      <tr>
        <td>
          {{ chamado.id }}
        </td>

        <td>
          {{ chamado.titulo }}
        </td>

        <td>
          {{ chamado.descricao }}
        </td>

        <td>
          {{ chamado.categoria }}
        </td>
        <td style="text-align: center !important">
          {{ chamado.createdAt | date : 'dd/MM/yyyy HH:mm' }}
        </td>

        <td>
          <div class="flex gap-3 mt-1 justify-center">
            <p-button
              icon="pi pi-pencil"
              size="small"
              variant="outlined"
              (click)="openEdit(chamado)"
            ></p-button>

            <p-button
              icon="pi pi-trash"
              size="small"
              variant="outlined"
              severity="danger"
              (click)="confirmDelete(chamado)"
            ></p-button>
          </div>
        </td>
      </tr>
    </ng-template>

    <ng-template pTemplate="emptymessage">
      <tr>
        <td colspan="5" class="text-center p-4 text-gray-500">
          <span class="flex items-center justify-center gap-2">
            <i class="pi pi-search-minus text-xl"></i>
            <span>Nenhum chamado encontrado.</span>
          </span>
        </td>
      </tr>
    </ng-template>
  </p-table>

  <p-dialog
    header="Editar Chamado"
    [(visible)]="displayDialog"
    [modal]="true"
    [closable]="true"
    [resizable]="false"
    styleClass="max-w-md mx-4 md:w-1/2 lg:w-1/3 xl:w-1/4"
  >
    @if (editingChamado) {
    <form class="p-fluid space-y-4">
      <div class="flex flex-col gap-1">
        <label class="font-medium">Título</label>
        <input pInputText [(ngModel)]="editingChamado.titulo" name="titulo" />
      </div>
      <div class="p-field flex flex-col gap-1">
        <label for="descricao" class="font-medium">Descrição</label>
        <textarea
          id="descricao"
          pInputTextarea
          class="w-full p-inputtext"
          rows="3"
          [(ngModel)]="editingChamado!.descricao"
          name="descricao"
        ></textarea>
      </div>

      <div class="flex flex-col gap-1">
        <label class="font-medium">Categoria</label>
        <p-autoComplete
          [(ngModel)]="editingChamado.categoria"
          name="categoria"
          [suggestions]="filteredCategorias"
          (completeMethod)="filterCategoria($event)"
          [dropdown]="true"
          [readonly]="true"
          appendTo="body"
        ></p-autoComplete>
      </div>

      <div class="flex justify-end gap-2 mt-4">
        <p-button
          label="Cancelar"
          severity="danger"
          [outlined]="true"
          (click)="displayDialog = false"
        ></p-button>
        <p-button
          label="Salvar"
          severity="success"
          [outlined]="true"
          (click)="saveEdit()"
        ></p-button>
      </div>
    </form>
    }
  </p-dialog>
</div>
